<!DOCTYPE html>
<html lang="en">
<head>
    <title>INFO 5100 - Project 1</title>
    <ul>
        <li> Jillian Beck - JLB574 </li>
        <li> Hung Ming Tseng - ht495 </li>
        <li> Peipei Duan - pd439 </li>
    </ul>
    <script src="https://d3js.org/d3.v7.min.js"></script>
  
    <style>
        .legend {
            font-size: 12px;
        }
        .gridlines line {
            stroke: #bbb;
        }
        .gridlines .domain {
            stroke: none;
        }
        .axis-label {
            font-size: 12px;
            font-weight: bold;
        }
        .chart-title {
            font-size: 16px;
            font-weight: bold;
            text-anchor: middle;
        }
    </style>
</head>

<body>

    <h3> Introduction </h3>
    <p> For our project, we intend to investigate the frequency of animal rescues within NYC Boroughs over a 5 year time frame, and the relationship between animals rescued and their respective species. </p>
    
    <svg id="graph" height="600" width="800" style="margin-top:50px"></svg>
    
    <script> 
    d3.csv("Urban_Park_Ranger_Animal_Condition_Response_20241001.csv", d3.autoType)
        .then(data => {
            console.log("Loaded Data: ", data); // Debugging line to check data

            const svg = d3.select("#graph");
            const width = svg.attr("width");
            const height = svg.attr("height");
            const margin = { top: 50, right: 50, bottom: 70, left: 70 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const graph = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Data processing
            data.forEach(d => {
                if (d["Animal Class"] === "Domestic") {
                    if (d["Species Description"].includes("Rabbit")) {
                        d["Animal Class"] = "Rabbit";
                    } else if (d["Species Description"].includes("Cat")) {
                        d["Animal Class"] = "Cat";
                    } else if (d["Species Description"].includes("Dog")) {
                        d["Animal Class"] = "Dog";
                    }
                }
            });

            const clean_data = data.filter(d => d["# of Animals"] >= 1 && d["# of Animals"] <= 20);
            console.log("Cleaned Data: ", clean_data); // Check cleaned data

            // Grouping data for the stacked bar chart
            const species = Array.from(new Set(clean_data.map(d => d['Animal Class'])));
            const boroughs = Array.from(new Set(clean_data.map(d => d['Borough'])));

            const nestedData = d3.rollup(clean_data, 
                v => d3.sum(v, d => d['# of Animals']), 
                d => d['Borough'], 
                d => d['Animal Class']
            );

            const stackedData = Array.from(nestedData, ([borough, speciesData]) => {
                return {
                    borough,
                    species: Array.from(speciesData, ([species, count]) => ({ species, count }))
                };
            });

            console.log("Stacked Data: ", stackedData); // Check stacked data

            const xScale = d3.scaleBand()
                .domain(boroughs)
                .range([0, chartWidth])
                .padding(0.1);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(stackedData, d => d3.sum(d.species, s => s.count))])
                .range([chartHeight, 0]);

            const color = d3.scaleOrdinal()
                .domain(species)
                .range(d3.schemeCategory10);

            // Create stacked data
            const stack = d3.stack()
                .keys(species)
                .value((d, key) => {
                    const found = d.species.find(s => s.species === key);
                    return found ? found.count : 0;
                });

            const series = stack(stackedData);

            // Draw bars
            graph.selectAll(".layer")
                .data(series)
                .join("g")
                .attr("class", "layer")
                .attr("fill", d => color(d.key))
                .selectAll("rect")
                .data(d => d)
                .join("rect")
                .attr("x", d => xScale(d.data.borough))
                .attr("y", d => yScale(d[1]))
                .attr("height", d => yScale(d[0]) - yScale(d[1]))
                .attr("width", xScale.bandwidth());

            // Axes
            graph.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0, ${chartHeight})`)
                .call(d3.axisBottom(xScale));

            graph.append("g")
                .attr("class", "y axis")
                .call(d3.axisLeft(yScale));

            // Add x-axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("x", width / 2)
                .attr("y", height - 10)
                .style("text-anchor", "middle")
                .text("Borough");

            // Add y-axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", 15)
                .style("text-anchor", "middle")
                .text("Number of Animals");

            // Add chart title
            svg.append("text")
                .attr("class", "chart-title")
                .attr("x", width / 2)
                .attr("y", 25)
                .style("text-anchor", "middle")
                .text("Animal Rescues by Borough in NYC");

            // Legend
            const legend = svg.selectAll(".legend")
                .data(species)
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(0, ${i * 20})`);

            legend.append("rect")
                .attr("x", width - 18)
                .attr("width", 18)
                .attr("height", 18)
                .style("fill", color);

            legend.append("text")
                .attr("x", width - 24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .style("text-anchor", "end")
                .text(d => d);
        })
        .catch(error => {
            console.error("Error loading data: ", error);
        });
    </script>
</body>
</html>
